# Harmonic Colors - 設計ディスカッション記録

## 概要
このドキュメントは、Harmonic Colorsプロジェクトの仕様策定に至るまでの議論の経緯を記録したものです。

---

## 初期要件（ユーザーからの依頼）

### プロジェクトの目的
コード進行を視覚的に表現するシステムの開発

### 基本要件
1. **対象**: 4和音まで
2. **視覚表現の原則**: 構成される音で視覚情報が変化
3. **コンセプト**: 共感覚（音を色で捉える）の模倣
4. **手法**: 色相の移り変わりでコード進行を表現
5. **初期アイデア**: 12音を円形に並べ、色相環と対応させる

### ユーザーからの質問
以下の2点について、多様な方法を列挙してほしい：
- コードの色の決定方法
- コードの移り変わりの表現方法

---

## 第1回提案：多様な方法の列挙

### コードの色の決定方法（11案）

#### 音高ベースの方法
1. **12音色相環マッピング**（ユーザーの初期案）
   - 各音に30度ずつの色相を割り当て

2. **調性明度システム**
   - メジャー：明るい色、マイナー：暗い色
   - ディミニッシュ/オーグメント：彩度で差別化

3. **音程比率スペクトル**
   - 構成音の周波数比から波長を計算し色に変換

4. **重心カラー**
   - 構成音それぞれに色を割り当て、RGB値を平均化

#### 機能和声ベースの方法
5. **和声機能カラーリング**
   - トニック：青系（安定）
   - ドミナント：赤系（緊張）
   - サブドミナント：緑/黄系（移行）

6. **テンション度マッピング**
   - 7th、9th、11th、13thで色の複雑さを変化
   - 彩度や明度のグラデーション

7. **調性距離色相**
   - 主調からの調性的距離で色相を決定
   - 五度圏上の距離を色相環の角度に対応

#### 感情・印象ベースの方法
8. **音楽心理学マッピング**
   - 和音の感情的印象と色彩心理学を対応

9. **調性格理論準拠**
   - 各調の伝統的な「性格」に色を割り当て

#### 数学的・幾何学的方法
10. **トーラス空間マッピング**
    - 五度圏と三度圏の二次元空間での位置から色を決定

11. **フーリエ変換色彩**
    - 和音の周波数スペクトルをフーリエ変換して色情報に変換

### コードの移り変わりの表現方法（17案）

#### 色変化による表現
1. **スムースグラデーション**
   - 前のコードから次のコードへ色が滑らかに変化

2. **レイヤー重ね合わせ**
   - 新旧コードがフェードイン/アウトで混色

3. **パルス波形**
   - コード変化時に明度/彩度がパルス状に変化

#### 空間配置による表現
4. **円環スライド**
   - 色相環自体が回転してコード変化を表現

5. **多層同心円**
   - 内側から外側へ時間軸、新コードが中心に現れ外へ広がる

6. **螺旋軌道**
   - 時間軸を螺旋状に配置

7. **粒子システム**
   - 各構成音を粒子として表現、コード変化で移動・消失・出現

#### 幾何学図形による表現
8. **多角形モーフィング**
   - 三和音=三角形、四和音=四角形、形状が滑らかに変形

9. **ボロノイ図変化**
   - 構成音を種点としたボロノイ図、コード変化で領域再構成

10. **フラクタルパターン**
    - コード構造を再帰的なフラクタルで表現

#### グラフ・ネットワークによる表現
11. **和声進行グラフ**
    - ノードがコード、エッジが進行

12. **リーマン・ネットワーク**
    - ネオ・リーマン変換の関係性をネットワーク表示

#### 時系列・波形による表現
13. **スペクトログラム風表示**
    - 横軸時間、縦軸音高

14. **リボン・ストリーム**
    - 複数の色リボンが並行して流れる

15. **オーロラエフェクト**
    - 揺らめく光のカーテンでコードを表現

#### インタラクティブ表現
16. **3D空間配置**
    - X軸：時間、Y軸：音高、Z軸：音量/強度

17. **VR環境没入**
    - 聴き手を取り囲む形で色彩空間を配置

---

## 第2回フィードバック：要件の明確化

### ユーザーからの追加要件

#### コードの色の決定について
1. **調性の統一感**
   - 転調時：ガラッと色を変える
   - 同一調：似た色を使用

2. **機能和声の扱い**
   - 機能和声ベースの方法を取り入れる
   - ただし極端な色分けはしない
   - ダイアトニックコードは似た色に

3. **テンション度マッピング**
   - 取り入れたい

4. **調性距離色相**
   - 詳細説明を求む
   - 調の色の統一性に良いのでは

5. **感情・印象ベース**
   - 採用しない（機械的に決定したい）

6. **数学的方法**
   - 検討の余地はあるが、音楽理論ベースで進めたい

### ユーザーの仮案
「12音色相環マッピング + 調性明度システム」で調の基本色を決定し、機能和声ベースの方法で基本色から変化させる

### 表現方法について
- メインは色の変化
- 表現方法は色を美しく、わかりやすくすることが目的

### 気になった表現方法
- スムースグラデーション
- 円環スライド
- 粒子システム
- 多角形モーフィング
- オーロラエフェクト

---

## 第2回提案：詳細分析と改良案

### 調性距離色相の詳細説明

**基本概念**: 主調からの「遠さ」を色相環上の距離で表現

**具体例**（C majorを基準=0度とした場合）:
```
C major（主調）     → 0度（赤）
G major（+1）       → 30度（赤橙）
D major（+2）       → 60度（橙）
F major（-1）       → 330度（赤紫）
B♭ major（-2）      → 300度（紫）
```

**メリット**:
- 転調の距離感が直感的
- 近親調は類似色、遠隔調は補色

**デメリット**:
- 同一調内のコード間の色差が小さすぎる可能性
- メジャー/マイナーの区別が必要

### ユーザー仮案の評価

#### メリット
1. 調性の統一感が保たれる
2. 段階的な実装が可能
3. 音楽理論との親和性
4. 予測可能性（機械的決定）

#### デメリット
1. 色の変化幅が限定的（同一調内では色相固定）
2. メジャー/マイナーの扱いが課題（C major と A minorの区別）
3. 機能和声が曖昧な場合の対応（モーダル、ジャズ）
4. テンション度との統合（HSV/HSL空間の次元不足）

### 改良案1：調ベース色相 + 機能和声明度 + テンション彩度

**色の決定フロー**:

1. **色相（H）**: ルート音ベース
   - コードのルート音を12音色相環にマッピング
   - C=0度、C#=30度、D=60度...
   - 同一調のダイアトニックコードは近似色相に

2. **明度（L）**: 機能和声 + 調性
   - トニック: +10%（明るめ）
   - ドミナント: -5%（やや暗め）
   - サブドミナント: +5%（やや明るめ）
   - マイナーコード: 全体的に-15%

3. **彩度（S）**: テンション度
   - 基準: 70%
   - 7th: +5%, 9th/11th/13th: 各+5%
   - オルタード: +10%
   - ディミニッシュ/オーグメント: +20%

**メリット**:
1. 調内での統一感
2. 転調の明確化
3. 機能和声の控えめな反映
4. テンション度の表現
5. HSL空間の有効活用

**デメリット**:
1. ルート音が同じ異なる調のコードが似る
2. 色相環上の配置が主観的

### 改良案2：調性色相 + ルート音明度 + テンション彩度

**色の決定フロー**:

1. **色相**: 現在の調（主音）
   - C majorの曲 → すべてのコードが赤系
   - G majorの曲 → すべてのコードが緑系

2. **明度**: ルート音の主音からの距離
   - 主音（I）: 最も明るい（70%）
   - 属音（V）: やや暗い（50%）

3. **彩度**: テンション度（同上）

**メリット**:
- 調の統一感が最も強い
- 転調時の変化が劇的

**デメリット**:
- 同一調内の変化が地味すぎる
- 調判定のロジックが必要

### 推奨
**改良案1**（調ベース色相 + 機能和声明度 + テンション彩度）が最適

理由：すべての要件を満たし、バランスが良い

---

## 第3回提案：2色マーブル方式

### ユーザーの新提案

#### 基本コンセプト
「調ベース色相」の色と「機能和声」の色の2色をマーブル模様のように同時表示

#### 色1：現在の調
- **色相**: 調を12音色相環にマッピング（C=0度、回転角度調整可能）
- **明度**: 基準明度（マイナーキーは低め）
- **彩度**: 基準彩度

#### 色2：現在のコード
- **色相**:
  - 調の色から機能和声ごとに角度を足し引き
  - ダイアトニックコードは±30度を限度
  - トニック: ±0度
  - ドミナント: +30度（または-30度）
  - サブドミナント: +15度

- **明度**:
  - トニック: メジャー+10%、マイナー-10%
  - その他: 要検討

- **彩度**: 思いついていない（テンションを反映？）

#### テンションの表現
色の変化に組み込むよりも、カラースプレー（アイスのスプレーのように散りばめる）が良いのでは

### ユーザーからの質問
- 上記案の評価
- テンション表示方法の評価

---

## 第3回回答：詳細評価と推奨

### 全体的な評価：★★★★☆（4/5）

この方法は多くの要件を満たし、独創的で美しい表現になる可能性が高い

### 色1（調ベース）の評価

**メリット**:
1. 調性の明確な可視化
2. 転調時に劇的な変化
3. 安定感の表現（音楽の「土台」を視覚化）
4. シンプルで実装しやすい

**推奨設定**:
- マイナーキーの明度調整: メジャー60-65%、マイナー40-45%
- 彩度: 70-80%（色2と差をつけるなら低めにして背景感を出す）

### 色2（コードベース）の評価

#### 色相の設計：★★★★☆

**改善提案**:
```
ドミナント（V）の色相決定：
- 属和音（V, V7）: +30度
- 代理和音（vii°, iii）: +20度
- 短調のドミナント（v, v7）: +25度

サブドミナント：
- IV, ii: +15度
- vi（代理）: +10度
- 短調のiv: +12度
```

#### 明度の設計：★★★☆☆（要改善）

**改善提案**:
```
明度の基準値：色1の明度を基準（B）として

メジャーコード：
- トニック: B + 10%
- サブドミナント: B + 5%
- ドミナント: B - 5%

マイナーコード：
- トニック: B + 0%
- サブドミナント: B - 5%
- ドミナント: B - 10%

ディミニッシュ/オーグメント：
- B - 15%

変化幅の限度：20-80%
```

#### 彩度の設計：★★☆☆☆（未定義）

**提案**:
```
基準彩度: 75%

3和音: 75%
7th: +5% → 80%
9th: さらに+5% → 85%
11th/13th: さらに+5% → 90%
オルタード: +10% → 最大95%
```

ただし、テンションを別要素で表現する案（カラースプレー）の方が推奨

### マーブル表現の評価：★★★★★

**メリット**:
1. 2つの情報の同時表現
2. 美しい視覚表現
3. 混色による中間色

**実装上の検討点**:

**マーブルの比率**:
```
- トニック: 色1が70%、色2が30%
- サブドミナント: 色1が50%、色2が50%
- ドミナント: 色1が30%、色2が70%
```

**マーブルパターンの生成方法**:
- Perlinノイズ使用が一般的
- パターンをゆっくりアニメーション
- シェーダー（WebGL/GPU）推奨

### テンション表示方法の評価

#### 案1：彩度反映
**評価**: ★★★☆☆
- メリット: 統合的、シンプル
- デメリット: 彩度の変化は気づきにくい

#### 案2：カラースプレー方式（★★★★★ 強く推奨）

**具体的イメージ**:
```
基本: マーブル模様（色1 + 色2）
+
テンション: 小さな色粒子が散りばめられる

7th: 白または金色の小粒子（密度：低）
9th: 追加で銀色の小粒子（密度：中）
#9/♭9: 赤みがかった粒子（目立つ）
#11: 青みがかった粒子
13th: 黄色みがかった粒子

密度と大きさでテンション数を表現
```

**メリット**:
1. 視覚的明確さ（テンションの「追加された」感じが直感的）
2. 情報の分離（基本和音とテンションが混乱しない）
3. 段階的表現（複雑さが粒子の多さで表現）
4. 美的魅力（きらびやかで華やか）
5. 拡張性（将来的に他の要素も粒子で表現可能）

**開発コスト**: 中（パーティクルシステムは既存ライブラリ活用可能）

#### 案3：エフェクトレイヤー
**評価**: ★★★☆☆
- 派手だが実装コスト高、複数テンション時の表現が複雑

#### 案4：境界線・輪郭
**評価**: ★★☆☆☆
- シンプルだが地味、複数テンション時の表現困難

### 総合推奨構成

```
【ベース】
色1（調）+ 色2（機能和声）のマーブル模様

【テンション】
カラースプレー方式の粒子

【アニメーション】
スムースグラデーション（コード間の遷移0.5秒）
```

### 懸念点と対策

#### 1. 色1と色2が近すぎる場合
**対策**:
- 明度を必ず変える（色2のトニックは+10%）
- マーブルパターンを残して質感の違いを出す
- トニックでは色1を100%表示にしてシンプルに（オプション）

#### 2. マイナーキーの判定
**対策**:
- ユーザーが手動で指定できるオプション
- 最初のコードや楽曲の主音から判定

#### 3. 転調の検出
**対策**:
- 簡易版: ユーザーが手動でマーカー設置
- 中間案: 直近N小節のコード分析で推定
- 高度版: 機械学習による調判定（開発コスト大）

---

## 最終決定事項

### システムの仕様
「ユーザーがキーとコード進行を入力し、その結果を聴覚と視覚で確認できる」作曲支援ソフトウェア

### 対応方針
1. **色1と色2が近すぎる場合**: 明度の違い（+10%）で進める。実装後に確認して調整
2. **マイナーキーの判定**: ユーザーがキーを入力する仕様のため問題なし
3. **転調の検出**: 同上。既存曲の視覚化は今後の課題

### 採用する方式
- **色の決定**: 2色マーブル方式
  - 色1: 調ベース色
  - 色2: 機能和声ベース色
- **テンション表示**: カラースプレー方式
- **遷移**: スムースグラデーション（0.5秒）

### 技術スタック
- **言語**: TypeScript
- **実行環境**: Webブラウザ
- **フレームワーク**: React
- **推奨ライブラリ**:
  - Three.js/PixiJS（グラフィックス）
  - Tone.js（Web Audio APIラッパー）
  - Vite（ビルドツール）

### 開発フェーズ
1. **フェーズ1（MVP）**: 基本的な色表示とコード再生
2. **フェーズ2（強化）**: マーブルパターンとアニメーション
3. **フェーズ3（完成）**: カラースプレーと設定機能
4. **フェーズ4（拡張）**: オプション機能

---

## 設計の根拠まとめ

### なぜこの方式を選んだか

1. **2色マーブル方式の採用理由**:
   - 調性と機能和声という2つの重要な音楽的要素を同時に視覚化
   - 転調時は色1が変化し劇的な変化
   - 同一調内では色1が一定で統一感を保ちつつ、色2が変化して機能の違いを表現
   - 美しく、音楽理論と整合性がある

2. **カラースプレー方式の採用理由**:
   - テンションノートは和音への「付加音」という音楽理論的概念と、視覚的メタファーが一致
   - 基本和音（マーブル）とテンション（スプレー）で情報を分離し、わかりやすい
   - 複雑な和音ほど視覚的に豊かになり、音楽的複雑さと視覚的複雑さが対応

3. **機械的な色決定**:
   - ユーザーの要望「できるだけ機械的に色を決定したい」を満たす
   - 音楽理論（機能和声、テンション度）に基づいた客観的なルール
   - 同じコード進行は常に同じ色になる予測可能性

4. **段階的な実装**:
   - MVP → 強化 → 完成のフェーズ分けにより、早期に動作確認可能
   - 各フェーズで実際の見た目を確認しながら調整できる

---

## 実装後の改良（2025-10-26）

### 色の知覚差に関する調整（issue #33）

#### 問題の発見
Phase 2の実装（issue #9, #10）完了後、同じ和声機能を持つコード（EmとAm）のマーブルパターンで、色1と色2の違いが認識しにくいという問題が発見されました。

#### 調査結果
人間の色覚に関する研究を調査：

1. **JND (Just Noticeable Difference)** - 最小可知差異
   - CIELAB色空間でΔE = 2.3程度が実際のJND
   - HSLは人間の知覚に対して非線形

2. **WCAGアクセシビリティ基準**
   - テキストと背景で明度差40%以上を推奨
   - コントラスト比4.5:1以上（AA基準）

3. **日本の配色ガイドライン**
   - 明度差（RGB基準）: 125以上で「読みやすい」
   - 色差（RGB基準）: 500以上で「読みやすい」

#### 実装した解決策
**スケールディグリーによる微調整**を追加（issue #33）:

当初の実装では、同じ和声機能内のコード（例: トニック機能のI、iii、vi）はほぼ同じ色相・彩度・明度でした。
これを改善するため、スケールディグリーに基づく微調整を追加：

**色相の微調整** (控えめに):
- トニック機能: I (±0°), iii (-8°), vi (+8°)
- サブドミナント機能: ii (-5°), IV (+5°)
- ドミナント機能: V (±0°), vii (-8°)

**彩度の微調整** (大幅に):
- トニック機能: I (±0%), iii (-15%), vi (+15%)
- サブドミナント機能: ii (-12%), IV (+12%)
- ドミナント機能: V (±0%), vii (-15%)

**明度の微調整** (大幅に):
- トニック機能: I (±0%), iii (-15%), vi (+15%)
- サブドミナント機能: ii (-12%), IV (+12%)
- ドミナント機能: V (±0%), vii (-15%)

#### 結果
Key=Cでの例：
- **C（I）とEm（iii）の色2の差**: 色相8°、彩度15%、明度15%
- **EmとAmの色2の差**: 色相16°、彩度30%、明度33%

これにより、同じ和声機能内のコード間でもマーブルパターンで明確に区別できるようになりました。

#### 設計判断の根拠
- **色相は控えめに調整**: ユーザー要望により、和声機能の一貫性を保つため
- **彩度と明度を大幅に調整**: 人間の色覚研究に基づき、知覚可能な差（30%程度）を確保
- **HSLの限界を認識**: より高度な実装ではLCH/LAB色空間が推奨されるが、当面はHSLで対応

---

**記録日**: 2025-10-22（初版）, 2025-10-26（更新）
**ステータス**: Phase 2完了、継続的な改良中
