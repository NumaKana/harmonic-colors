# Harmonic Colors - システム仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**Harmonic Colors** - コード進行視覚化システム

### 1.2 目的
コード進行を色彩とビジュアルエフェクトで表現することで、音楽理論の学習と作曲支援を行うWebアプリケーション。
ユーザーがキーとコード進行を入力し、その結果を聴覚と視覚の両方で確認できる。

### 1.3 コンセプト
- 調性の変化を色相の変化で表現
- 機能和声を色の変化で表現
- テンションノートを装飾的な視覚要素で表現
- 共感覚的な体験の提供

---

## 2. 技術仕様

### 2.1 開発環境
- **言語**: TypeScript
- **実行環境**: Webブラウザ
- **フレームワーク**: React
- **ビルドツール**: Vite（推奨）

### 2.2 主要ライブラリ（推奨）
- **Three.js** または **PixiJS**: 2D/3Dグラフィックス、マーブル表現、パーティクルシステム
- **Tone.js**: Web Audio APIラッパー、音楽的な音声生成
- **React**: UIコンポーネント、状態管理

### 2.3 対応ブラウザ
- Chrome, Edge, Firefox, Safari（最新版）
- Web Audio API、WebGL対応必須

---

## 3. 機能仕様

### 3.1 入力機能

#### 3.1.1 キー設定
- **入力方法**: ドロップダウン選択
- **選択肢**:
  - メジャーキー: C, C#, D, D#, E, F, F#, G, G#, A, A#, B
  - マイナーキー: Cm, C#m, Dm, D#m, Em, Fm, F#m, Gm, G#m, Am, A#m, Bm

#### 3.1.2 コード進行入力
- **入力方法**: GUI操作（ボタン選択、ドラッグ&ドロップなど）
- **対応コードタイプ**:
  - トライアド: メジャー（例: C）、マイナー（例: Cm）、ディミニッシュ（例: Cdim）、オーグメント（例: Caug）
  - セブンスコード: 7（例: C7）、maj7（例: Cmaj7）、m7（例: Cm7）、m7♭5（例: Cm7♭5）、dim7（例: Cdim7）
  - テンションノート: ♭9, 9, #9, 11, #11, 13, ♭13
  - 表記例: `C9`, `Dm7`, `G7♭9`, `Fmaj7#11`

**Phase 1-3**: ダイアトニックコードのみ対応（パレットから選択）
**Phase 4**: ノンダイアトニックコード対応（カスタム入力機能を追加）

#### 3.1.3 拍子・タイミング設定
- **BPM**: 数値入力（40-240、初期値: 120）
- **拍子**: 4/4固定（将来的に拡張可能）
- **各コードの長さ**: 1拍〜8拍（初期値: 4拍）

### 3.2 音声出力

#### 3.2.1 音源
- **技術**: Web Audio API（Tone.js使用推奨）
- **音色**: シンセサイザー（ピアノ風、パッド系など選択可能）
- **ボイシング**: 基本3〜4声（ルート、3度、5度、7度）+ テンション

#### 3.2.2 再生制御
- **再生/停止**: ボタン操作
- **ループ再生**: オプション
- **音量調整**: スライダー

#### 3.2.3 メトロノーム機能
- **目的**: 拍を視覚的・聴覚的に明確にし、リズム感を把握しやすくする
- **クリック音**: 各拍でクリック音を再生
  - 1拍目: アクセント音（高音または大音量）
  - その他の拍: 通常音
- **ON/OFF切り替え**: トグルボタンで有効/無効を切り替え
- **音色**: シンプルなクリック音またはウッドブロック音
- **音量**: メインのコード音声とは独立して調整可能
- **実装**: Tone.jsのTransportと同期してクリック音をスケジュール

### 3.3 視覚表示

#### 3.3.1 表示領域
- **サイズ**: 固定 800x600px（初期実装）
- **アスペクト比**: 4:3
- **背景**: 黒または暗いグレー（色が映えるように）

#### 3.3.2 色彩システム

##### A. 色1：調ベース色
現在の調を表す基準色

| パラメータ | 決定方法 |
|---------|---------|
| **色相（H）** | 調の主音を12音色相環にマッピング<br>C=0°, C#=30°, D=60°, ..., B=330°<br>※ ユーザーが回転角度を調整可能 |
| **明度（L）** | メジャーキー: 60-65%<br>マイナーキー: 40-45% |
| **彩度（S）** | 70-80%（中〜やや高） |

##### B. 色2：コードベース色
現在のコードの機能和声を表す色

**色相（H）の決定:**
```
基準: 色1の色相

【機能和声による角度調整】
- トニック（I, iii, vi）: 基本調整 ±0°
- サブドミナント（ii, IV）: 基本調整 +15°
- ドミナント（V, vii）: 基本調整 +30°

【スケールディグリーによる微調整】
※ 同じ和声機能内でのコード区別のため（issue #33で追加）

トニック機能内:
- I: 微調整なし (±0°)
- iii: -8°
- vi: +8°

サブドミナント機能内:
- ii: -5°
- IV: +5°

ドミナント機能内:
- V: 微調整なし (±0°)
- vii: -8°

※ ダイアトニックコード内では最大±38°の範囲
※ ノンダイアトニックコードは要検討（将来実装）
```

**明度（L）の決定:**
```
基準: 色1の明度をBとする

【メジャーコード（和声機能による調整）】
- トニック: B + 10%
- サブドミナント: B + 5%
- ドミナント: B - 5%

【マイナーコード（和声機能による調整）】
- トニック: B + 0%
- サブドミナント: B - 5%
- ドミナント: B - 10%

【特殊コード】
- ディミニッシュ/オーグメント: B - 15%

【スケールディグリーによる微調整】
※ 同じ和声機能内でのコード区別のため（issue #33で追加）

トニック機能内:
- I: 微調整なし (±0%)
- iii: -15%
- vi: +15%

サブドミナント機能内:
- ii: -12%
- IV: +12%

ドミナント機能内:
- V: 微調整なし (±0%)
- vii: -15%

※ 範囲制限: 20-80%
※ 知覚可能な色差を確保するため、明度差±15%程度を設定
```

**彩度（S）の決定:**
```
基準彩度: 75%

【テンションによる調整】
- 3和音（トライアド）: 75%
- 7th: 80%
- 9th: 85%
- 11th/13th: 90%
- オルタードテンション（♭9, #9, #11, ♭13）: 95%
- ディミニッシュ/オーグメント: 90%

【スケールディグリーによる微調整】
※ 同じ和声機能内でのコード区別のため（issue #33で追加）

トニック機能内:
- I: 微調整なし (±0%)
- iii: -15%
- vi: +15%

サブドミナント機能内:
- ii: -12%
- IV: +12%

ドミナント機能内:
- V: 微調整なし (±0%)
- vii: -15%

※ 範囲制限: 0-100%
※ 知覚可能な色差を確保するため、彩度差±15%程度を設定
※ テンションは主にカラースプレーで表現するため、彩度は補助的
```

##### C. マーブル表現
色1と色2を混合して表示

**マーブル比率:**
```
- トニック: 色1が70% : 色2が30%
- サブドミナント: 色1が65% : 色2が35%
- ドミナント: 色1が50% : 色2が50%

※ issue #9で初期実装
※ issue #36で調整（トニック: 80% → 70%）
```

**生成方法:**
- ドメインワーピング技法による流体マーブリングパターン（issue #37で実装）
  - 3層FBM（Fractal Brownian Motion）ノイズによる歪み
  - 有機的で渦巻くようなパターン
  - 伝統的なマーブリングアートを模倣
- GLSLシェーダーによる実装
- 時間経過でゆっくりとアニメーション

##### D. カラースプレー（テンション表示）
テンションノートを小さな色粒子として散りばめる

**粒子の色:**
```
- 7th: 金色（控えめ）
- 9th: 銀色
- #9/♭9: 赤みがかった色（アクセント）
- 11th: 青みがかった色
- #11: 明るい青
- 13th: 黄色みがかった色
- ♭13: オレンジ色
```

**粒子の密度:**
```
- 7th: 低密度（約50個）
- 9th: 中密度（約30個追加）
- オルタードテンション: 高密度（約70個追加）
- 複数テンション時: 累積
```

**粒子のサイズ:**
- 小: 2-4px
- 中: 5-8px（オルタードテンション）

**アニメーション:**
- ゆっくりと浮遊、回転
- フェードイン/アウト

#### 3.3.3 コード遷移アニメーション
- **遷移時間**: 0.3秒（issue #10で調整済み）
- **イージング関数**: easeOutExpo（速く始まり、ゆっくり終わる）
- **方式**: スムースグラデーション
  - 色1 → 新色1へ滑らかに変化
  - 色2 → 新色2へ滑らかに変化
  - マーブル比率も補間
  - 色相は最短経路で補間（360°を考慮）
  - カラースプレー粒子はフェードイン/アウト（将来実装）

#### 3.3.4 タイムライン表示（issue #25, #43で実装）
コード進行全体を横スクロールのタイムラインとして表示

**表示場所:**
- **確認フェーズ**のみで使用
- **組み立てフェーズ**では小さなVisualizationPreviewを使用

**Timeline View（タイムライン表示）**
コード進行を左から右へ流れるタイムラインとして表示。2つのサブモードを持つ：

**a. Playback Mode（再生モード）**
```
- 再生位置インジケーター（白い縦線）が画面中央に固定
- カメラが等速で左から右へ移動（音楽の流れに同期）
- 約5拍分（2.5ユニット幅）のビューポート
- requestAnimationFrameによる60fpsの滑らかな位置更新
- 経過ビート数に基づく連続的な位置計算
```

**b. Preview Mode（プレビューモード）**
```
- 固定幅ビューポート：約8拍分（4.0ユニット幅）
- 1拍 = 0.5ユニットの固定スケール
- ドラッグで横スクロール可能
- カーソル：grab / grabbing
- ヒント表示：「💡 Drag to scroll horizontally」
- スクロール範囲制限（over-scroll防止）
```

**ビジュアル連続性:**
```
- マーブルパターン：タイムライン全体で連続
  - ワールド座標ベースのUV計算
  - セグメント間の継ぎ目が目立たない
- 色グラデーション：隣接コード間で30%のブレンド領域
  - 各セグメントの右端30%が次のコードの色に向かって遷移
  - 滑らかな色の流れを実現
```

**スケーリング:**
```
- 横幅：chord.duration × 0.5ユニット
  - 例：4拍 = 2.0ユニット幅
- 高さ：固定2.0ユニット
```

**技術実装:**
```
- Three.js PlaneGeometry × マーブルシェーダー
- OrthographicCamera による2D的な表示
- マウスイベントによるドラッグスクロール
- GLSLシェーダーによる連続パターン生成
```

### 3.4 ユーザー設定

#### 3.4.1 色相環回転調整
- **入力方法**: 数値入力（0-359°）
- **効果**: C音の色相角度を調整
- **リアルタイム反映**: 設定変更時に即座に視覚更新

#### 3.4.2 その他設定（将来拡張）
- マーブル比率の調整
- 粒子密度の調整
- アニメーション速度
- 色の明度・彩度の全体調整

---

## 4. UI設計

### 4.1 画面レイアウト

アプリケーションは「**組み立てフェーズ**」と「**確認フェーズ**」の2つのモードに分離されています（issue #43で実装）。

#### 4.1.1 組み立てフェーズ（Build Phase）

コード進行を構築・編集するための画面

```
┌─────────────────────────────────────────────┐
│  Harmonic Colors   [組み立て] [確認]        │
├─────────────────────────────────────────────┤
│  Key: [C Major ▼]                           │
├─────────────────────────────────────────────┤
│  Diatonic Chords  Duration: [♩ Quarter]    │
│  ┌───┬───┬───┬───┬───┬───┬───┐             │
│  │ I │ ii│iii│ IV│ V │ vi│vii│             │
│  │ C │ Dm│ Em│ F │ G │ Am│Bdim│            │
│  ├───┼───┼───┼───┼───┼───┼───┤             │
│  │色 │色 │色 │色 │色 │色 │色 │  ← 色プレビュー │
│  └───┴───┴───┴───┴───┴───┴───┘             │
├─────────────────────────────────────────────┤
│  Chord Progression（4小節/行表示）          │
│  ┌─────┬─────┬─────┬─────┐                 │
│  │  C  │  Am │  F  │  G  │  Measure 1     │
│  └─────┴─────┴─────┴─────┘                 │
├─────────────────────────────────────────────┤
│  [▶ Play] [⏸ Stop] BPM:[120] 拍子:[4/4]   │
│  Metronome: [ON/OFF]                       │
├─────────────────────────────────────────────┤
│  Visualization Preview                     │
│  ┌───────────────────────────────────────┐  │
│  │                                       │  │
│  │      マーブルパターンプレビュー          │  │
│  │                                       │  │
│  └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│  Color 1 (Key): C major  [色見本]          │
│  Color 2 (Chord): G (V)  [色見本]          │
│                                             │
│  Chord: G                                   │
│  Roman Numeral: V                           │
│  Function: Dominant                         │
│  Diatonic: Yes                              │
└─────────────────────────────────────────────┘
```

#### 4.1.2 確認フェーズ（Confirm Phase）

コード進行全体を視覚化・確認するための画面

```
┌─────────────────────────────────────────────┐
│  Harmonic Colors   [組み立て] [確認]        │
├─────────────────────────────────────────────┤
│  Chord Name Bar（スクロール表示）            │
│  ... [F] → [G] ← [C] [Am] ...              │
├─────────────────────────────────────────────┤
│                                             │
│                                             │
│        Timeline Visualization               │
│     （コード進行を横スクロール表示）           │
│                                             │
│                                             │
│                                             │
├─────────────────────────────────────────────┤
│  [Playback] [Preview]                       │
│  （タイムライン表示モード切り替え）            │
└─────────────────────────────────────────────┘
```

**Timeline View モード:**
- **Playback**: 再生位置に追従してカメラが移動
- **Preview**: ドラッグで横スクロール可能

### 4.2 コンポーネント構成

```
App
├── Header（タイトル、フェーズタブ）
├── BuildPhase（組み立てフェーズ）
│   ├── KeySelector（キー選択）
│   ├── ChordPalette（ダイアトニックコード選択）
│   │   ├── DurationSelector（音符の長さ選択）
│   │   └── ChordButton + ChordColorPreview（色プレビュー付き）
│   ├── ChordSequence（コード進行表示・編集）
│   │   └── MeasureDisplay（4小節/行の譜面的表示）
│   ├── PlaybackControls（再生制御）
│   │   ├── PlayButton
│   │   ├── StopButton
│   │   ├── BPMControl
│   │   ├── TimeSignatureControl
│   │   └── MetronomeToggle
│   ├── VisualizationPreview（マーブルプレビュー）
│   └── ColorInfoDisplay（色情報・和声機能表示）
│       ├── ColorSwatches（色見本）
│       └── HarmonicInfo（ローマ数字、機能など）
└── ConfirmPhase（確認フェーズ）
    ├── ChordNameBar（現在のコード名表示）
    └── VisualizationCanvas（Timeline View）
        ├── TimelineVisualization（タイムライン描画）
        │   ├── PlaybackMode（再生追従モード）
        │   └── PreviewMode（ドラッグスクロールモード）
        └── CompactPlayButton（コンパクト再生ボタン）
```

---

## 5. データ構造

### 5.1 コード表現

```typescript
interface Chord {
  root: Note;              // ルート音 (C, C#, D, ..., B)
  quality: ChordQuality;   // メジャー、マイナー、ディミニッシュなど
  seventh?: SeventhType;   // 7th, maj7, m7, dim7
  tensions: Tension[];     // [9, 11, 13] など
  alterations: Alteration[]; // [#9, b13] など
  duration: number;        // 拍数
}

type Note = 'C' | 'C#' | 'D' | 'D#' | 'E' | 'F' | 'F#' | 'G' | 'G#' | 'A' | 'A#' | 'B';

type ChordQuality = 'major' | 'minor' | 'diminished' | 'augmented';

type SeventhType = '7' | 'maj7' | 'm7' | 'm7b5' | 'dim7' | 'aug7';

type Tension = 9 | 11 | 13;

type Alteration = 'b9' | '#9' | '#11' | 'b13';

interface ChordProgression {
  key: Key;
  chords: Chord[];
  bpm: number;
}

interface Key {
  tonic: Note;
  mode: 'major' | 'minor';
}
```

### 5.2 色情報

```typescript
interface ColorHSL {
  hue: number;        // 0-360
  saturation: number; // 0-100
  lightness: number;  // 0-100
}

interface ChordColor {
  baseColor: ColorHSL;      // 色1（調ベース）
  chordColor: ColorHSL;     // 色2（コードベース）
  marbleRatio: number;      // 色1と色2の比率 (0-1)
  particles: ParticleConfig[]; // テンション粒子設定
}

interface ParticleConfig {
  color: string;      // 粒子の色（RGB or HSL）
  count: number;      // 粒子数
  size: number;       // サイズ（px）
  type: string;       // テンションタイプ識別
}
```

### 5.3 機能和声分析

```typescript
interface HarmonicFunction {
  romanNumeral: string;  // I, ii, iii, IV, V, vi, vii°
  function: 'tonic' | 'subdominant' | 'dominant';
  isDiatonic: boolean;
}

// コードから機能和声を判定する関数
function analyzeHarmonicFunction(chord: Chord, key: Key): HarmonicFunction;
```

---

## 6. 実装フェーズ

### フェーズ1: MVP（最小限の動作）
**目標**: 基本的な色表示とコード再生

- [ ] プロジェクトセットアップ（React + TypeScript + Vite）
- [ ] キー選択UI
- [ ] 単純なコード入力UI（固定のダイアトニックコードボタン）
- [ ] 色1（調ベース）の生成ロジック
- [ ] 色2（コードベース）の生成ロジック（色相のみ）
- [ ] 単色またはシンプルなグラデーション表示
- [ ] Web Audio APIによる基本的な音声再生
- [ ] 再生/停止機能

### フェーズ2: ビジュアル強化
**目標**: マーブル表現とアニメーション

- [ ] Three.js/PixiJSの統合
- [ ] マーブルパターン生成（Perlinノイズ）
- [ ] 明度・彩度の調整システム実装
- [ ] コード間のスムースグラデーション（0.5秒遷移）
- [ ] BPM設定とタイミング制御
- [ ] Tone.jsへの移行（音楽的な音声生成）

### フェーズ3: 完成版
**目標**: テンション表示と設定機能

- [ ] カラースプレー（パーティクルシステム）実装
- [ ] テンションノート入力UI
- [ ] 各テンションタイプの粒子表現
- [ ] 色相環回転調整UI
- [ ] 設定の保存/読み込み
- [ ] UI/UXの洗練
- [ ] パフォーマンス最適化

### フェーズ4: 拡張機能（オプション）
- [ ] **ノンダイアトニックコード入力機能**（優先度：高）
- [ ] コード進行のプリセット（よくある進行）
- [ ] エクスポート機能（動画、GIF）
- [ ] コード進行の保存/共有
- [ ] 拍子の変更対応
- [ ] より複雑なコード（sus4, add9など）対応
- [ ] MIDIファイルインポート

---

## 7. 技術的考慮事項

### 7.1 パフォーマンス
- **目標**: 60fps以上の滑らかな描画
- **手法**:
  - WebGLシェーダーでマーブル生成（GPU活用）
  - パーティクルのインスタンシング
  - 不要な再レンダリング抑制（React.memo使用）

### 7.2 音声遅延
- Web Audio APIのレイテンシ対策
- スケジューリング精度の確保

### 7.3 ブラウザ互換性
- Web Audio API、WebGLの対応確認
- フォールバック処理（非対応ブラウザ用）

### 7.4 アクセシビリティ
- キーボード操作対応
- 色覚異常への配慮（色以外の情報提供）

---

## 8. 初期設定値まとめ

| 項目 | 初期値 | 備考 |
|-----|-------|------|
| C音の色相角度 | 0°（赤） | ユーザー調整可能 |
| BPM | 120 | 40-240の範囲 |
| 拍子 | 4/4 | 固定 |
| 各コードの長さ | 4拍 | 可変 |
| コード遷移時間 | 0.5秒 | 固定 |
| 表示サイズ | 800x600px | 固定 |
| マーブル比率 | 要調整 | 実装後に決定 |
| 色1明度（Major） | 60-65% | 要調整 |
| 色1明度（Minor） | 40-45% | 要調整 |
| 色1彩度 | 70-80% | 要調整 |

---

## 9. 今後の検討事項

### 9.1 色設定の調整
- マーブル比率の最適値
- 明度・彩度の微調整
- トニックで色1と色2が近すぎる問題への対策

### 9.2 機能拡張
- ノンダイアトニックコード（借用和音、セカンダリードミナント）の扱い
- モーダルインターチェンジへの対応
- より複雑なリズムパターン

### 9.3 ユーザビリティ
- チュートリアル/ヘルプ機能
- サンプル進行の提供
- より直感的なコード入力方法

### 9.4 将来的な発展
- 既存楽曲の視覚化（音源解析、MIDI読み込み）
- リアルタイム演奏の視覚化
- VRへの対応

---

## 10. 参考資料

### 10.1 音楽理論
- 機能和声理論
- ネオ・リーマン理論
- ジャズハーモニー

### 10.2 色彩理論
- HSL色空間
- 色相環
- 色彩心理学

### 10.3 共感覚研究
- 音と色の対応関係
- クロマティック・シンセジア

---

**作成日**: 2025-10-22
**バージョン**: 1.0
**ステータス**: 承認済み
